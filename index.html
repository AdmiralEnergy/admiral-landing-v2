<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <meta name="supported-color-schemes" content="light" />
  <meta name="theme-color" content="#f7f5f2" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <title>Admiral Energy — Lower Bills. Quiet Backup. Solar That Fits.</title>

  <!-- Favicon set (generated at build) -->
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16.png?v=2" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32.png?v=2" />
  <link rel="icon" type="image/png" sizes="48x48" href="/assets/favicon-48.png?v=2" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png?v=2" />
  <link rel="icon" href="/assets/favicon.ico?v=2" sizes="any" />
  <link rel="shortcut icon" href="/assets/favicon.ico?v=2" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Admiral Energy — Lower Bills. Quiet Backup. Solar That Fits." />
  <meta property="og:description" content="60 seconds to check fit for solar + battery. No pressure, no spam." />
  <meta property="og:image" content="/assets/share-image.png" />
  <meta property="og:url" content="https://admiralenergy.netlify.app" />
  <meta property="og:site_name" content="Admiral Energy" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Admiral Energy — Lower Bills. Quiet Backup. Solar That Fits." />
  <meta name="twitter:description" content="60 seconds to check fit for solar + battery. No pressure, no spam." />
  <meta name="twitter:image" content="/assets/share-image.png" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Calendly -->
  <link href="https://assets.calendly.com/assets/external/widget.css" rel="stylesheet" />
  <script src="https://assets.calendly.com/assets/external/widget.js" async></script>

  <!-- GTM -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PDPNZ37H');
  </script>

  <!-- Reddit Pixel -->
  <script>
    !function(w,d){if(!w.rdt){var p=w.rdt=function(){
    p.sendEvent?p.sendEvent.apply(p,arguments):p.callQueue.push(arguments)};
    p.callQueue=[];var t=d.createElement("script");
    t.src="https://www.redditstatic.com/ads/pixel.js";t.async=!0;
    var s=d.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}}
    (window,document);
    rdt('init','a2_hpzbegj1w700');
    rdt('track','PageVisit');
  </script>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RX78MRB03L"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-RX78MRB03L', {
      // Enhanced conversion tracking
      send_page_view: true,
      custom_map: {
        'custom_parameter_1': 'lead_id',
        'custom_parameter_2': 'bill_amount',
        'custom_parameter_3': 'zip_code',
        'custom_parameter_4': 'utility_provider'
      }
    });
    
    // UTM capture and persistence system
    window.getUtmState = function() {
      // Get UTMs from URL or localStorage
      const urlParams = new URLSearchParams(window.location.search);
      const utmParams = {};
      
      // UTM parameters to track
      const utmKeys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term'];
      
      // First check URL
      utmKeys.forEach(key => {
        const urlValue = urlParams.get(key);
        if (urlValue) {
          utmParams[key] = urlValue;
          localStorage.setItem(key, urlValue);
        } else {
          // Fallback to localStorage
          const storedValue = localStorage.getItem(key);
          if (storedValue) {
            utmParams[key] = storedValue;
          }
        }
      });
      
      // Add referrer
      utmParams.referrer = document.referrer;
      
      return utmParams;
    };
    
    // Initialize UTMs on page load
    getUtmState();
    
    // Reddit and GA4 event helpers with retry + de-dupe
    window.fireReddit = function(eventName, payload = {}) {
      const utms = getUtmState();
      const finalPayload = { ...payload, ...utms };
      
      // Debug mode: log but don't send
      if (window.AE_DEBUG) {
        console.log('[Reddit Debug]', eventName, finalPayload);
        return;
      }
      
      try {
        rdt('track', eventName, finalPayload);
        
        // Retry mechanism on network issues
        let retryCount = 0;
        const maxRetries = 3;
        
        const retryOnFailure = () => {
          if (retryCount >= maxRetries) return;
          
          const retry = () => {
            retryCount++;
            try {
              rdt('track', eventName, finalPayload);
            } catch(e) {
              if (retryCount < maxRetries) {
                setTimeout(retry, 1000 * retryCount);
              }
            }
          };
          
          // Retry on visibility change (user comes back)
          document.addEventListener('visibilitychange', () => {
            if (!document.hidden) retry();
          }, { once: true });
          
          // Retry on online
          window.addEventListener('online', retry, { once: true });
        };
        
        retryOnFailure();
      } catch(e) {
        console.warn('Reddit tracking failed:', e);
      }
    };
    
    window.fireGA4Lead = function(lead_id, utms = {}) {
      if (!lead_id) return;
      
      // De-dupe check
      const dedupeKey = 'lead_sent_' + lead_id;
      if (sessionStorage.getItem(dedupeKey)) {
        return; // Already sent
      }
      
      // Debug mode: log but still send to GA4 (GA4 has its own debug view)
      if (window.AE_DEBUG) {
        console.log('[GA4 Debug] generate_lead', { lead_id, ...utms });
      }
      
      try {
        gtag('event', 'generate_lead', {
          lead_id: lead_id,
          ...utms
        });
        
        // Mark as sent
        sessionStorage.setItem(dedupeKey, '1');
      } catch(e) {
        console.warn('GA4 lead tracking failed:', e);
      }
    };

    // Legacy tracking function for backward compatibility
    const trackEvent = (eventName, data = {}) => {
      const leadId = data.lead_id || window.leadId || '';
      
      // GA4 tracking (existing)
      gtag('event', eventName, {
        ...data,
        lead_id: leadId,
        event_category: 'engagement',
        event_label: data.section || eventName
      });
      
      // Console log for debugging (remove in production)
      if(window.AE_DEBUG) {
        console.log('[Tracking]', eventName, data);
      }
    };

    // Enhanced ecommerce tracking for lead funnel
    const trackFunnelStep = (step, action, data = {}) => {
      // Use unified tracking
      trackEvent('funnel_step', {
        funnel_step: step,
        funnel_action: action,
        value: data.value || 0,
        currency: 'USD',
        ...data
      });
    };
    
    // Page engagement tracking
    let pageStartTime = Date.now();
    let maxScroll = 0;
    let formInteractions = 0;
    
    // Track scroll depth
    window.addEventListener('scroll', () => {
      const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
      maxScroll = Math.max(maxScroll, scrollPercent);
      
      // Track milestone scrolls
      if (scrollPercent > 0 && scrollPercent % 25 === 0 && !window[`scroll_${scrollPercent}`]) {
        window[`scroll_${scrollPercent}`] = true;
        gtag('event', 'scroll', {
          scroll_depth: scrollPercent,
          page_title: document.title
        });
      }
    });
    
    // Track time on page and engagement on unload
    window.addEventListener('beforeunload', () => {
      const timeOnPage = Math.round((Date.now() - pageStartTime) / 1000);
      gtag('event', 'page_engagement', {
        engagement_time_msec: timeOnPage * 1000,
        max_scroll_depth: maxScroll,
        form_interactions: formInteractions
      });
    });
  </script>

  <style>
    :root{
      --primary-navy:#0c2f4a; --accent-gold:#c9a648; --dark-gold:#9b7b2d; --bone-white:#f7f5f2; --text-gray:#4a5568; /* Darker for better contrast */
    }
    *{box-sizing:border-box} html,body{margin:0;padding:0;font-family:"Rubik",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:var(--bone-white);color:#1f2937}
    a{color:var(--primary-navy)}
    
    /* Micro-animations */
    .btn{padding:.95rem 1rem;border-radius:12px;border:none;font-weight:700;cursor:pointer;transition:all .2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .btn:active{transform:translateY(0)}
    .btn-primary{background:linear-gradient(135deg,var(--accent-gold),var(--dark-gold));color:#fff}
    .btn-primary:hover{background:linear-gradient(135deg,var(--dark-gold),var(--accent-gold));box-shadow:0 6px 20px rgba(201,166,72,.4)}
    .btn-secondary{background:transparent;color:var(--primary-navy);border:2px solid var(--primary-navy)}
    .btn-secondary:hover{background:var(--primary-navy);color:white}
    
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 30px rgba(12,47,74,.06);transition:transform .2s ease,box-shadow .2s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 16px 40px rgba(12,47,74,.1)}
    
    .option-card{padding:1rem;border:2px solid #e5e7eb;border-radius:10px;text-align:center;cursor:pointer;background:#fff;transition:all .2s ease}
    .option-card:hover{border-color:var(--accent-gold);transform:translateY(-2px);box-shadow:0 4px 12px rgba(201,166,72,.15)}
    .option-card.selected{border-color:var(--accent-gold);background:linear-gradient(135deg,rgba(201,166,72,.08),rgba(201,166,72,.03));animation:pulse .3s ease}
    
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    @keyframes slideIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:none}}
    
    .urgency-banner{animation:slideIn .5s ease}
    .savings-preview{animation:fade .4s ease .1s both}
    
    /* Form animations */
    .cta input, .cta select{flex:1;padding:.9rem;border-radius:12px;border:1px solid #d7d3cb;background:#fff;min-width:0;transition:all .2s ease}
    .cta input:focus, .cta select:focus{border-color:var(--accent-gold);box-shadow:0 0 0 3px rgba(201,166,72,.1);transform:translateY(-1px)}
    
    /* Layout */
    .container{max-width:1100px;margin:0 auto;padding:1.25rem}
    header{background:linear-gradient(135deg,#fff,rgba(201,166,72,.08));border-bottom:1px solid #eee}
    .hero{display:grid;gap:1.25rem;grid-template-columns:1.2fr .8fr;align-items:center;padding:2rem 0}
    .badgeRow{display:flex;gap:.75rem;flex-wrap:wrap;margin:.5rem 0}
    .badgeRow span{background:#fff;border:1px solid #e5e7eb;padding:.35rem .6rem;border-radius:999px;font-size:.8rem}
    .cardPad{padding:1rem}
    .cta{display:flex;gap:.5rem}

    /* Progress */
    .progress{height:8px;background:#ececec;border-radius:999px;overflow:hidden;margin:.5rem 0}
    .progress-fill{height:100%;width:0;background:linear-gradient(90deg,var(--accent-gold),var(--dark-gold));transition:width .35s ease}

    /* Quiz */
    .quiz{margin-top:1rem}
    .quiz-step{display:none}
    .quiz-step.active{display:block;animation:fade .35s ease}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    .options-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem}
    .option-card{padding:1rem;border:2px solid #e5e7eb;border-radius:10px;text-align:center;cursor:pointer;background:#fff;transition:.2s}
    .option-card:hover{border-color:var(--accent-gold);transform:translateY(-2px)}
    .option-card.selected{border-color:var(--accent-gold);background:linear-gradient(135deg,rgba(201,166,72,.08),rgba(201,166,72,.03))}

    .bill-display{text-align:center;font-size:1.8rem;font-weight:800;color:var(--primary-navy)}

    .outcome-card{background:linear-gradient(135deg,#fff,rgba(201,166,72,.05));border-radius:20px;padding:2rem;margin-top:1rem}
    .savings-highlight{background:linear-gradient(135deg,var(--accent-gold),var(--dark-gold));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-size:2.4rem;font-weight:900}

    .next-steps{display:grid;grid-template-columns:1.1fr .9fr;gap:1.25rem;align-items:start;margin-top:1rem}
    .actions{display:flex;gap:.75rem;flex-wrap:wrap}
    .actions .btn{min-width:160px;margin:.25rem}

    /* Upload Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:50;padding:1rem;overflow:auto}
    .modal .box{max-width:620px;margin:2rem auto;background:#fff;border-radius:20px;padding:1.5rem}
    .upload-zone{border:2px dashed var(--accent-gold);border-radius:12px;padding:2rem;text-align:center;background:rgba(201,166,72,.06);cursor:pointer}
    .upload-zone:hover{background:rgba(201,166,72,.1)}
    .upload-zone.dragover{background:rgba(201,166,72,.15);transform:scale(1.01)}
    .file-preview{margin-top:1rem;padding:1rem;background:var(--bone-white);border-radius:10px}

    /* Trust */
    .trust{padding:3rem 0}
    .badges{display:flex;justify-content:center;gap:2rem;flex-wrap:wrap;margin-bottom:2rem}
    .badge{display:flex;flex-direction:column;align-items:center;gap:.35rem}
    .badge .ico{width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,rgba(201,166,72,.1),rgba(201,166,72,.05))}

    footer{padding:2rem 0;color:#6b7280;text-align:center}

    /* Real-time validation styles */
    .input-valid{border-color:#10b981!important;background-image:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="%2310b981"><path d="M12.416 3.376a.75.75 0 0 1 .208 1.04l-5 7.5a.75.75 0 0 1-1.154.114l-3-3a.75.75 0 0 1 1.06-1.06l2.353 2.353 4.493-6.74a.75.75 0 0 1 1.04-.207Z"/></svg>');background-position:right 8px center;background-repeat:no-repeat;background-size:16px}
    .input-invalid{border-color:#ef4444!important;background-image:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="%23ef4444"><path d="M5.28 4.22a.75.75 0 0 0-1.06 1.06L6.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L8 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L9.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L8 6.94 5.28 4.22Z"/></svg>');background-position:right 8px center;background-repeat:no-repeat;background-size:16px}
    .validation-message{font-size:.8rem;margin-top:.25rem;transition:all .2s ease}
    .validation-message.success{color:#10b981}
    .validation-message.error{color:#ef4444}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    
    /* Focus styles */
    button:focus, input:focus, select:focus{outline:2px solid var(--accent-gold);outline-offset:2px}
    
    /* Skeleton loading screens */
    .skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    
    .video-skeleton{position:absolute;inset:0;background:var(--bone-white);display:flex;align-items:center;justify-content:center;color:var(--text-gray)}
    .quiz-skeleton{height:200px;border-radius:12px;margin:1rem 0}
    
    /* Lazy loading */
    .lazy-video{opacity:0;transition:opacity .3s}
    .lazy-video.loaded{opacity:1}
    
    /* Touch gestures and mobile improvements */
    .touch-controls{display:none;position:absolute;bottom:10px;left:10px;right:10px;justify-content:space-between;z-index:2}
    .touch-btn{background:rgba(0,0,0,.6);color:white;border:none;border-radius:20px;padding:.4rem .8rem;font-size:.8rem;cursor:pointer}
    
    /* Video hover overlay for mobile */
    .video-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.3);opacity:0;transition:opacity .3s;pointer-events:none}
    .video-container:hover .video-overlay{opacity:1}
    
    /* Improved form spacing */
    .cta input, .cta select{padding:1rem;font-size:16px} /* Prevent zoom on iOS */
    
    /* Better button spacing */
    .actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.75rem}
    
    /* Enhanced mobile optimization */
    @media (max-width:880px){
      /* Container and spacing improvements */
      .container{padding:1rem}
      
      /* Header optimizations */
      header{padding:.5rem 0}
      .hero{grid-template-columns:1fr;gap:1.5rem;padding:1.5rem 0}
      .hero > div:first-child{order:1}
      .hero > div:last-child{order:2}
      
      /* Typography scaling for mobile */
      .hero h1{font-size:1.8rem !important;line-height:1.2 !important;margin-bottom:.5rem !important}
      .hero p{font-size:.95rem;line-height:1.4;margin:.4rem 0 .75rem !important}
      
      /* Urgency banner mobile optimization */
      .urgency-banner{font-size:.85rem !important;padding:.6rem !important;margin-bottom:1rem !important;line-height:1.3}
      
      /* Badge row mobile optimization */
      .badgeRow{gap:.4rem;justify-content:center;margin:.75rem 0 1rem}
      .badgeRow span{font-size:.75rem;padding:.3rem .5rem}
      
      /* Form optimizations */
      .cta{flex-direction:column;gap:.75rem}
      .cta input, .cta select{padding:1rem;font-size:16px;border-radius:8px}
      .cta button{padding:1rem;font-size:16px;border-radius:8px;font-weight:700}
      
      /* Card padding adjustments */
      .cardPad{padding:.75rem}
      
      /* Video container mobile optimization */
      .video-container{margin:0;border-radius:12px}
      video{width:100%;height:auto;border-radius:12px}
      
      /* Actions/buttons mobile optimization */
      .actions{display:grid;grid-template-columns:1fr;gap:.75rem;margin-top:1rem}
      .actions .btn{flex:1 1 100%;min-width:0;margin:0;padding:1rem;font-size:16px;text-align:center;border-radius:8px}
      
      /* Quiz optimizations */
      .quiz h3{font-size:1.3rem;margin-bottom:.75rem}
      .bill-display{font-size:1.6rem;margin:.5rem 0}
      .savings-preview{padding:.75rem;margin:.75rem 0;border-radius:8px}
      .savings-preview p{font-size:.85rem;margin:.25rem 0}
      
      /* Lead form mobile optimization */
      .lead-form > div{grid-template-columns:1fr !important;gap:.75rem}
      .lead-form input{padding:1rem;font-size:16px;border-radius:8px}
      
      /* Options grid mobile */
      .options-grid{grid-template-columns:1fr;gap:.75rem}
      .option-card{padding:1rem;font-size:.9rem;border-radius:8px}
      
      /* Outcome section mobile */
      .outcome-card{padding:1.5rem;border-radius:16px}
      .outcome-card h2{font-size:1.4rem;margin:.25rem 0 .5rem}
      .savings-highlight{font-size:2rem !important}
      
      /* Next steps mobile layout */
      .next-steps{grid-template-columns:1fr;gap:1.5rem}
      
      /* Trust section mobile */
      .trust{padding:2rem 0}
      .trust h2{font-size:1.6rem;margin-bottom:1.5rem}
      .badges{gap:1rem;margin-bottom:1.5rem}
      .badge{text-align:center}
      .badge span{font-size:.8rem}
      
      /* Testimonials mobile */
      .card[style*="grid-template-columns"]{display:block !important}
      .card blockquote{margin-bottom:1rem !important}
      .card blockquote:last-child{margin-bottom:0 !important}
      
      /* Touch controls */
      .touch-controls{display:flex}
      
      /* Modal optimizations */
      .modal{padding:.5rem}
      .modal .box{margin:1rem auto;padding:1rem;border-radius:16px}
      
      /* Upload zone mobile */
      .upload-zone{padding:1.5rem;border-radius:8px;font-size:.9rem}
      
      /* Bill slider mobile */
      #billSlider{width:100%;margin:.75rem 0}
    }
    
    /* Additional mobile breakpoint for very small screens */
    @media (max-width:480px){
      .container{padding:.75rem}
      .hero{padding:1rem 0}
      .hero h1{font-size:1.6rem !important}
      .cardPad{padding:.5rem}
      .outcome-card{padding:1rem}
      .savings-highlight{font-size:1.8rem !important}
      .badges{flex-direction:column;align-items:center;gap:.75rem}
    }
  </style>
</head>
<body>
  <!-- GTM (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PDPNZ37H" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <header>
    <div class="container hero">
      <div>
        <div class="urgency-banner" style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:white;padding:.5rem .75rem;border-radius:8px;margin-bottom:.75rem;text-align:center;font-size:.9rem;font-weight:600">
          ⚠️ Federal Solar Tax Credit Expires Dec 31, 2025 • Duke PowerPair Program Filling Fast!
        </div>
        <h1 style="margin:0 0 .35rem;color:var(--primary-navy);font-size:2.2rem;line-height:1.15">Lower Bills. Quiet Backup. Solar That Fits.</h1>
        <p style="margin:.25rem 0 .5rem;color:var(--text-gray);max-width:56ch">60 seconds to check fit for solar + battery in Charlotte. Get up to <strong>$9,000 Duke PowerPair rebate</strong> + 30% federal tax credit.</p>
        <p style="margin:0 0 1rem;color:#dc2626;font-weight:600;font-size:.9rem">✅ Veteran‑owned • ⏰ Limited capacity remaining</p>
        <div class="badgeRow">
          <span>✅ Licensed & Insured</span>
          <span>⚡ 25‑Year Warranty</span>
          <span>📍 Local Team</span>
          <span>🎖️ Veteran‑Owned</span>
        </div>

        <!-- Lead / Hero minimal form (ZIP + Utility) -->
        <div class="card cardPad">
          <form id="heroForm" class="cta" onsubmit="return false" role="form" aria-labelledby="hero-form-heading">
            <h2 id="hero-form-heading" class="sr-only">Get Your Solar Savings Estimate</h2>
            <input required id="zip" name="zip" inputmode="numeric" pattern="[0-9]{5}" placeholder="ZIP code" aria-label="ZIP code" aria-describedby="zip-help" />
            <div id="zip-help" class="sr-only">Enter your 5-digit ZIP code to check solar availability in your area</div>
            <select required id="utility" name="utility" aria-label="Select your utility provider" aria-describedby="utility-help">
              <option value="" disabled selected>Utility</option>
              <option value="duke">Duke Energy</option>
              <option value="other">Other</option>
            </select>
            <div id="utility-help" class="sr-only">Select your current electricity provider</div>
            <button class="btn btn-primary" id="startQuiz" aria-describedby="start-help">Check savings</button>
            <div id="start-help" class="sr-only">Start your personalized solar assessment</div>
          </form>
          <div class="progress" aria-hidden="true"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
          <div id="welcomeBack" style="display:none;color:#065f46;font-weight:700;margin-top:.25rem"></div>
        </div>
      </div>

      <div class="card">
        <div class="video-container" style="position:relative;aspect-ratio:16/9;overflow:hidden;border-radius:16px">
          <div class="video-skeleton skeleton">📹 Loading video...</div>
          <video id="admiralExplainer" class="lazy-video" style="width:100%;height:100%;object-fit:cover" playsinline muted loop preload="none"
                 data-src="/assets/admiral-intro.mp4"></video>
          <div class="video-overlay">
            <div class="touch-controls">
              <button class="touch-btn" id="playPauseBtn" tabindex="0">⏸️ Pause</button>
              <button class="touch-btn" id="touchMuteBtn" tabindex="0">🔇 Unmute</button>
            </div>
          </div>
        </div>
        <div class="cardPad" style="display:flex;justify-content:flex-end"><button id="explainerMute" class="btn btn-secondary" type="button">🔊 Mute</button></div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- QUIZ -->
    <section id="quiz" class="quiz card cardPad" aria-live="polite" style="display:none">
      <div id="quizSkeleton" class="quiz-skeleton skeleton" style="display:flex;align-items:center;justify-content:center;color:var(--text-gray)">
        📋 Loading your personalized solar assessment...
      </div>
      <!-- Step 1: Bill amount -->
      <div class="quiz-step" data-step="1" role="tabpanel" aria-labelledby="step1-heading">
        <h3 id="step1-heading" style="margin-top:0;color:var(--primary-navy)">What's your average monthly electric bill?</h3>
        <input type="range" min="50" max="500" value="150" step="5" id="billSlider" class="slider" 
               aria-label="Monthly electric bill amount" aria-describedby="bill-value bill-help" />
        <div class="bill-display"><span id="billVal" aria-live="polite">$150</span>/mo</div>
        <div id="bill-value" class="sr-only">Current value: $150 per month</div>
        <div class="savings-preview" style="background:linear-gradient(135deg,rgba(201,166,72,.1),rgba(201,166,72,.05));padding:.75rem;border-radius:8px;margin:.5rem 0">
          <p style="margin:0;font-weight:600;color:var(--primary-navy)">💰 Estimated Savings at this Bill Level:</p>
          <p id="bill-help" style="margin:.25rem 0 0;font-size:.9rem;color:var(--text-gray)">• Monthly: 30-55% reduction • Annual: $900-$1,800 saved • Duke PowerPair: Up to $9,000 rebate • Federal Credit: 30% of system cost</p>
        </div>
        <div style="display:flex;gap:.5rem;justify-content:flex-end">
          <button class="btn btn-primary" id="next1" aria-describedby="next1-help">Next →</button>
          <div id="next1-help" class="sr-only">Continue to contact information step</div>
        </div>
      </div>

      <!-- Step 2: Contact info (LEAD CAPTURE) -->
      <div class="quiz-step" data-step="2">
        <h3 style="margin-top:0;color:var(--primary-navy)">Where should we send your savings report?</h3>
        <form id="lead-form" class="hs-form" name="lead-capture" method="POST" data-netlify="true">
          <input type="hidden" name="form-name" value="lead-capture" />
          <input type="hidden" name="lead_id" id="lead_id" />
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
            <input required name="first_name" id="firstName" placeholder="First name" />
            <input required name="last_name" id="lastName" placeholder="Last name" />
            <input required type="email" name="email" id="email" placeholder="Email" />
            <input required name="phone" id="phone" placeholder="Phone" />
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:.75rem">
            <input required name="zip" id="zip_hidden" placeholder="ZIP" />
            <input required name="utility" id="utility_hidden" placeholder="Utility" />
          </div>
          <input type="hidden" name="bill_amount" id="bill_hidden" />
          <label style="display:flex;gap:.5rem;align-items:center;margin:.75rem 0 0">
            <input type="checkbox" id="optin" name="opt_in" value="yes" />
            <span style="font-size:.9rem;color:#374151">Okay to email & text me my savings report and updates. I can reply STOP to opt out.</span>
          </label>
          <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.75rem">
            <button type="button" class="btn btn-secondary" id="back2">← Back</button>
            <button type="submit" class="btn btn-primary" id="submitLead">See my savings</button>
          </div>
        </form>
      </div>

      <!-- Step 3: Optional refinement -->
      <div class="quiz-step" data-step="3">
        <h3 style="margin-top:0;color:var(--primary-navy)">A few quick details (optional)</h3>
        <div class="options-grid" id="roofType">
          <div class="option-card" data-val="shingle">🏠 Shingle Roof</div>
          <div class="option-card" data-val="metal">🔩 Metal Roof</div>
          <div class="option-card" data-val="tile">🧱 Tile Roof</div>
          <div class="option-card" data-val="flat">⬜ Flat Roof</div>
        </div>
        <p class="micro-value">This helps us right-size your system. You can skip this step.</p>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem">
          <button class="btn btn-secondary" id="skip3">Skip</button>
          <button class="btn btn-primary" id="next3">Continue</button>
        </div>
      </div>
    </section>

    <!-- OUTCOME -->
    <section id="outcome" style="display:none">
      <div class="outcome-card">
        <h2 style="margin:.25rem 0 0;color:var(--primary-navy)">You're a strong fit for solar + battery</h2>
        <p style="margin:.25rem 0;color:var(--text-gray)">Based on your bill of <strong id="out_bill">$150</strong>/mo, here's your potential savings with Duke PowerPair:</p>
        <div class="savings-highlight" id="out_savings">$900–$1,800/yr</div>
        <div style="background:linear-gradient(135deg,rgba(201,166,72,.1),rgba(201,166,72,.05));padding:1rem;border-radius:12px;margin:.75rem 0">
          <h4 style="margin:0 0 .5rem;color:var(--primary-navy);font-size:1.1rem">💡 Your Duke PowerPair Incentives:</h4>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.5rem;font-size:.9rem">
            <div><strong>Solar Rebate:</strong> Up to $3,600</div>
            <div><strong>Battery Rebate:</strong> Up to $5,400</div>
            <div><strong>Federal Tax Credit:</strong> 30% of system</div>
            <div><strong>Total Potential:</strong> $15,000+ savings</div>
          </div>
          <p style="margin:.5rem 0 0;font-size:.85rem;color:#dc2626;font-weight:600">⏰ PowerPair program capacity filling fast - 60,000 kW limit!</p>
        </div>
        
        <!-- Social Proof Section -->
        <div style="background:rgba(255,255,255,.8);border-radius:12px;padding:1rem;margin:.75rem 0;border-left:4px solid var(--accent-gold)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
            <h4 style="margin:0;color:var(--primary-navy);font-size:1rem">Recent Customer Success</h4>
            <div id="recentCount" style="color:#10b981;font-weight:700;font-size:.9rem">47 homeowners qualified this week</div>
          </div>
          <blockquote style="margin:0;font-size:.9rem;font-style:italic;color:var(--text-gray)">
            "Cut my Duke Energy bill by 45% and the battery backup gives us peace of mind during storm season. The Admiral team handled everything from permits to install."
            <cite style="display:block;margin-top:.25rem;font-size:.8rem;color:#6b7280">— Tony R., Ballantyne (installed last month)</cite>
          </blockquote>
        </div>
        <div class="next-steps">
          <div class="actions">
            <button class="btn btn-primary" id="bookCall">📅 Book a 15‑min review</button>
            <button class="btn btn-secondary" id="openBillUpload">📎 Upload Duke bill (faster quote)</button>
            <button class="btn" id="instantCallback" style="background:#25D366;color:white">📞 Instant callback</button>
            <button class="btn" id="liveChat" style="background:#0084FF;color:white">💬 Live chat now</button>
          </div>
          <div>
            <div class="video-container" style="position:relative;width:100%;max-height:400px;overflow:visible;border-radius:16px;background:#f0f0f0">
              <div class="video-skeleton skeleton">📹 Loading video...</div>
              <video id="outcomeExplainer" class="admiral-explainer lazy-video" playsinline muted loop preload="none" style="width:100%;height:auto;max-height:400px;object-fit:contain" data-src="/assets/admiral-bill-explainer.mp4" poster="/assets/admiral-bill-explainer-poster.png"></video>
              <div class="video-overlay">
                <div class="touch-controls">
                  <button class="touch-btn" id="outPlayPauseBtn" tabindex="0">⏸️ Pause</button>
                  <button class="touch-btn" id="outTouchMuteBtn" tabindex="0">🔇 Unmute</button>
                </div>
              </div>
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:.5rem">
              <button id="outcomeMute" class="btn btn-secondary" type="button" style="font-size:.85rem;padding:.5rem .75rem">🔊 Mute</button>
            </div>
            <p style="color:var(--text-gray);font-size:.9rem;margin:.35rem 0 0">We use your address (roof & sun) + kWh from your bill to size your system precisely.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- TRUST -->
    <section class="trust">
      <h2 style="text-align:center;color:var(--primary-navy);font-size:2rem">Why Charlotte Homeowners Trust Admiral Energy</h2>
      <div class="badges">
        <div class="badge"><div class="ico">🎖️</div><span style="font-weight:600">Veteran‑Owned</span></div>
        <div class="badge"><div class="ico">📍</div><span style="font-weight:600">Local Team</span></div>
        <div class="badge"><div class="ico">✅</div><span style="font-weight:600">Licensed & Insured</span></div>
        <div class="badge"><div class="ico">🛠️</div><span style="font-weight:600">25‑Year Warranty</span></div>
        <div class="badge"><div class="ico">⚡</div><span style="font-weight:600">Workmanship Guarantee</span></div>
      </div>
      <div class="card cardPad" style="display:grid;gap:1rem;grid-template-columns:1fr 1fr">
        <blockquote style="margin:0"><p style="margin:0 0 .35rem">“Outage last week? We didn’t notice—battery switched instantly. The Admiral team handled everything from permits to install.”</p><cite style="color:var(--text-gray)">— Sarah M., Myers Park</cite></blockquote>
        <blockquote style="margin:0"><p style="margin:0 0 .35rem">“Cut my Duke Energy bill by 45% and the battery backup gives us peace of mind during storm season. Professional crew, zero hassle.”</p><cite style="color:var(--text-gray)">— Tony R., Ballantyne</cite></blockquote>
      </div>
    </section>
  </main>

  <!-- Bill Upload Modal (Netlify form) -->
  <div class="modal" id="billModal" aria-hidden="true">
    <div class="box">
      <form id="bill-upload" name="bill-upload" method="POST" data-netlify="true" enctype="multipart/form-data">
        <input type="hidden" name="form-name" value="bill-upload" />
        <input type="hidden" name="lead_id" id="bu_lead_id" />
        <input type="hidden" name="email" id="bu_email" />
        <input type="hidden" name="first_name" id="bu_first_name" />
        <input type="hidden" name="phone" id="bu_phone" />
        <input type="hidden" name="opt_in" id="bu_opt_in" value="no" />

        <h3 style="margin:0 0 .25rem">Upload your Duke bill (front page)</h3>
        <p style="margin:.25rem 0;color:var(--text-gray)">We use your <strong>address</strong> (roof & sun) and <strong>kWh</strong> (system size). You may hide your account #. <a href="/assets/duke-bill-sample.png" target="_blank" rel="noopener">See sample</a>.</p>

        <div id="bu_drop" class="upload-zone" role="button" tabindex="0">📁 Drag & drop or click — PDF/JPG/PNG/HEIC (max 10 MB)</div>
        <button type="button" id="bu_attach_btn" class="btn btn-secondary" style="width:100%;margin-top:.5rem">📎 Attach bill</button>
        <input type="file" id="dukeBillInput" name="duke_bill" accept=".pdf,.jpg,.jpeg,.png,.heic,image/*,application/pdf" capture="environment" style="display:none" />

        <div class="file-preview" id="bu_preview" hidden>
          <strong>Selected file</strong>
          <div id="bu_preview_content" style="margin-top:.35rem"></div>
        </div>

        <label for="serviceAddress" style="display:block;margin:.75rem 0 .25rem;font-weight:600">Service address (optional)</label>
        <input id="serviceAddress" name="service_address" placeholder="Street, City, ZIP" style="width:100%;padding:.8rem;border:1px solid #d7d3cb;border-radius:10px" />

        <div style="display:flex;gap:.5rem;justify-content:center;margin-top:1rem">
          <button type="submit" class="btn btn-primary" id="bu_submit" disabled>Submit & Book My Review Call</button>
          <button type="button" class="btn btn-secondary" id="bu_skip">Skip — Book without upload</button>
          <button type="button" class="btn" id="bu_close">Close</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Exit Intent (Netlify form) -->
  <form id="exit-form" name="exit-intent-capture" method="POST" data-netlify="true" hidden>
    <input type="hidden" name="form-name" value="exit-intent-capture" />
    <input type="hidden" name="email" id="exit_email" />
    <input type="hidden" name="zip" id="exit_zip" />
    <input type="hidden" name="utility" id="exit_utility" />
  </form>

  <!-- Cookie Consent Modal -->
  <div id="cookieConsent" class="modal" style="display:none" aria-hidden="true">
    <div class="box" style="max-width:500px">
      <h3 style="margin:0 0 .5rem">Cookie & Privacy Notice</h3>
      <p style="margin:.5rem 0;font-size:.9rem">We use cookies and similar technologies to analyze website traffic, personalize content, and provide social media features. We also share information about your use of our site with our analytics partners.</p>
      <div style="display:flex;gap:.5rem;margin-top:1rem">
        <button class="btn btn-primary" id="acceptCookies">Accept All</button>
        <button class="btn btn-secondary" id="manageCookies">Manage Preferences</button>
        <button class="btn" id="declineCookies">Decline Non-Essential</button>
      </div>
      <p style="margin:.5rem 0 0;font-size:.8rem;color:#6b7280">
        By continuing, you agree to our <a href="#privacy" style="color:var(--accent-gold)">Privacy Policy</a> and <a href="#terms" style="color:var(--accent-gold)">Terms of Service</a>.
      </p>
    </div>
  </div>

  <!-- Privacy Policy Modal -->
  <div id="privacyModal" class="modal" style="display:none" aria-hidden="true">
    <div class="box" style="max-width:700px">
      <h3 style="margin:0 0 1rem">Privacy Policy</h3>
      <div style="max-height:400px;overflow-y:auto;padding-right:.5rem">
        <h4>Information We Collect</h4>
        <p>We collect information you provide directly, such as name, email, phone, ZIP code, utility provider, and electric bill information for solar assessment purposes.</p>
        
        <h4>How We Use Your Information</h4>
        <p>We use your information to provide personalized solar assessments, schedule consultations, and communicate about our services. We may also use aggregated, non-personal information for analytics.</p>
        
        <h4>Information Sharing</h4>
        <p>We do not sell your personal information. We may share information with service providers who help us operate our business, and as required by law.</p>
        
        <h4>Data Security</h4>
        <p>We implement appropriate technical and organizational measures to protect your personal information against unauthorized access, alteration, disclosure, or destruction.</p>
        
        <h4>Your Rights</h4>
        <p>You have the right to access, update, or delete your personal information. You can also opt out of marketing communications at any time.</p>
        
        <h4>Contact Us</h4>
        <p>For privacy-related questions, contact us at privacy@admiralenergy.com or (704) 555-0123.</p>
      </div>
      <div style="display:flex;justify-content:center;margin-top:1rem">
        <button class="btn btn-secondary" onclick="document.getElementById('privacyModal').style.display='none'">Close</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="container">© <span id="year"></span> Admiral Energy — Charlotte, NC • Licensed & Insured</div>
  </footer>

  <script>
    // Small helpers
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
    const aeEvt = (name, params={}) => { 
      try { 
        // Use unified tracking system
        trackEvent(name, params);
        
        // Enhanced tracking with funnel steps (for backward compatibility)
        const funnelSteps = {
          'quiz_started': { step: 1, value: 100 },
          'quiz_step_1_complete': { step: 2, value: 200 },
          'lead_captured': { step: 3, value: 500 },
          'calendly_opened': { step: 4, value: 750 },
          'bill_uploaded': { step: 5, value: 1000 },
          'instant_callback_requested': { step: 4, value: 500 },
          'live_chat_opened': { step: 4, value: 300 }
        };
        
        if (funnelSteps[name]) {
          trackFunnelStep(funnelSteps[name].step, name, { 
            ...params, 
            value: funnelSteps[name].value 
          });
        }
        
        formInteractions++;
      } catch(_){
        console.warn('Tracking error:', _);
      } 
    };
    const showToast = (msg) => { try{ if(window.Toastify){ Toastify({text:msg}).showToast(); } }catch(_) { console.log('[Toast]', msg) } };

    // Debug flag via ?debug=1
    (function(){ const q=new URLSearchParams(location.search); window.AE_DEBUG = window.AE_DEBUG || (q.get('debug')==='1');})();

    // Lead ID + cookie/localStorage persistence (30 days)
    function makeLeadId(){ return 'lead_'+Date.now()+'_'+Math.random().toString(36).slice(2,8); }
    function setCookie(k,v,days){ const d=new Date(Date.now()+days*864e5).toUTCString(); document.cookie=`${k}=${encodeURIComponent(v)}; path=/; expires=${d}`; }
    function getCookie(k){ return document.cookie.split('; ').find(r=>r.startsWith(k+'='))?.split('=')[1] }

    function saveState(data){
      const state = { ...data, timestamp: Date.now() };
      try { localStorage.setItem('ae_state', JSON.stringify(state)); } catch(_){ }
      if(data.leadId){ setCookie('ae_lead_id', data.leadId, 30); setCookie('ae_lead_captured', data.leadCaptured?'1':'0', 30); }
    }
    function loadState(){ try{ const s=localStorage.getItem('ae_state'); return s?JSON.parse(s):null }catch(_){ return null } }

    // UI state
    const heroForm = $('#heroForm');
    const startBtn = $('#startQuiz');
    const quiz = $('#quiz');
    const steps = $$('.quiz-step');
    const progressFill = $('#progressFill');

    const billSlider = $('#billSlider');
    const billVal = $('#billVal');

    const leadForm = $('#lead-form');
    const outcome = $('#outcome');

    let leadId = getCookie('ae_lead_id') || makeLeadId();

    function setProgress(stepIdx, total=3){ const pct = Math.max(5, Math.round((stepIdx/total)*100)); progressFill.style.width = pct+'%'; }
    function goto(step){ steps.forEach(s=>s.classList.remove('active')); const el = steps.find(s=>s.dataset.step==step); if(el){ el.classList.add('active'); setProgress(step-1); } }

    // Welcome-back logic with 30-day window and restart option
    (function(){
      const state = loadState();
      const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000; // 30 days in milliseconds
      
      if(state?.leadCaptured && state.timestamp){
        const timeSinceCapture = Date.now() - state.timestamp;
        
        if(timeSinceCapture <= THIRTY_DAYS){
          $('#welcomeBack').style.display='block';
          $('#welcomeBack').innerHTML = `
            <div>Welcome back${state.firstName ? ', '+state.firstName : ''}! Your quote is ready.</div>
            <div style="margin-top:0.5rem;">
              <button class="btn btn-secondary" id="restartTest" style="font-size:0.85rem;padding:0.4rem 0.8rem;">Is this not you? Restart test</button>
            </div>
          `;
          billVal.textContent = `$${state.billAmount||150}`;
          $('#out_bill').textContent = `$${state.billAmount||150}`;
          renderOutcome(state.billAmount||150);
          heroForm.style.display='none';
          quiz.style.display='none';
          outcome.style.display='block';
          setProgress(3);
          
          // Add restart functionality
          $('#restartTest').addEventListener('click', () => {
            // Clear stored state
            localStorage.removeItem('ae_state');
            setCookie('ae_lead_id', '', -1); // Delete cookie
            setCookie('ae_lead_captured', '', -1); // Delete cookie
            
            // Reset UI
            $('#welcomeBack').style.display='none';
            heroForm.style.display='block';
            quiz.style.display='none';
            outcome.style.display='none';
            setProgress(0);
            
            // Generate new lead ID
            leadId = makeLeadId();
            window.leadId = leadId;
            
            // Track restart event
            aeEvt('test_restarted', { previous_lead_id: state.leadId, new_lead_id: leadId });
            
            // Scroll to form
            heroForm.scrollIntoView({behavior:'smooth',block:'center'});
          });
        } else {
          // Outside 30-day window, clear old state
          localStorage.removeItem('ae_state');
          setCookie('ae_lead_id', '', -1);
          setCookie('ae_lead_captured', '', -1);
          leadId = makeLeadId();
          window.leadId = leadId;
        }
      }
    })();

    // Scarcity counter animation
    const updateScarcityCounters = () => {
      // Simulate dynamic counters based on realistic data
      const baseDate = new Date('2024-06-21'); // PowerPair program restart
      const now = new Date();
      const daysSinceStart = Math.floor((now - baseDate) / (1000 * 60 * 60 * 24));
      
      // Simulate weekly qualifications (realistic numbers)
      const weeklyBase = 35;
      const randomFactor = Math.floor(Math.random() * 15) + 5;
      const weeklyCount = weeklyBase + randomFactor;
      
      // Update recent customer count
      const recentCountEl = $('#recentCount');
      if (recentCountEl) {
        recentCountEl.textContent = `${weeklyCount} homeowners qualified this week`;
      }
      
      // Calculate PowerPair capacity used (realistic progression)
      const totalCapacity = 60000; // 60,000 kW total
      const monthlyUsage = 800; // Approximate kW used per month
      const capacityUsed = Math.min(totalCapacity, daysSinceStart * (monthlyUsage / 30));
      const capacityRemaining = totalCapacity - capacityUsed;
      const percentRemaining = Math.round((capacityRemaining / totalCapacity) * 100);
      
      // Add capacity remaining indicator to urgency banner
      const urgencyBanner = $('.urgency-banner');
      if (urgencyBanner && !urgencyBanner.dataset.updated) {
        urgencyBanner.dataset.updated = 'true';
        urgencyBanner.innerHTML = `
          ⚠️ Federal Solar Tax Credit Expires Dec 31, 2025 • Duke PowerPair: ${percentRemaining}% Capacity Remaining!
        `;
      }
    };
    
    // Update counters on load and periodically
    updateScarcityCounters();
    setInterval(updateScarcityCounters, 30000); // Update every 30 seconds

    // Real-time form validation
    const validators = {
      zip: (value) => ({
        isValid: /^\d{5}$/.test(value),
        message: value.length === 0 ? '' : /^\d{5}$/.test(value) ? '✅ Valid ZIP code' : '❌ Enter 5-digit ZIP code'
      }),
      email: (value) => ({
        isValid: /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),
        message: value.length === 0 ? '' : /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value) ? '✅ Valid email' : '❌ Enter valid email address'
      }),
      phone: (value) => {
        const cleaned = value.replace(/\D/g, '');
        return {
          isValid: cleaned.length >= 10,
          message: value.length === 0 ? '' : cleaned.length >= 10 ? '✅ Valid phone number' : '❌ Enter 10-digit phone number'
        };
      },
      name: (value) => ({
        isValid: value.trim().length >= 2,
        message: value.length === 0 ? '' : value.trim().length >= 2 ? '✅ Valid name' : '❌ Enter at least 2 characters'
      })
    };

    const validateInput = (input, validatorKey) => {
      const result = validators[validatorKey](input.value);
      
      // Update input styling
      input.classList.remove('input-valid', 'input-invalid');
      if (input.value.length > 0) {
        input.classList.add(result.isValid ? 'input-valid' : 'input-invalid');
      }
      
      // Update/create validation message
      let msgElement = input.parentNode.querySelector('.validation-message');
      if (!msgElement && result.message) {
        msgElement = document.createElement('div');
        msgElement.className = 'validation-message';
        input.parentNode.appendChild(msgElement);
      }
      
      if (msgElement) {
        msgElement.textContent = result.message;
        msgElement.className = `validation-message ${result.isValid ? 'success' : 'error'}`;
        if (!result.message) {
          msgElement.remove();
        }
      }
      
      return result.isValid;
    };

    // Apply real-time validation to inputs
    const setupValidation = (selector, validatorKey) => {
      const input = document.querySelector(selector);
      if (input) {
        input.addEventListener('input', () => validateInput(input, validatorKey));
        input.addEventListener('blur', () => validateInput(input, validatorKey));
      }
    };

    // Setup validation for hero form
    setupValidation('#zip', 'zip');
    
    // Setup validation for lead form (will be active once form is shown)
    const setupLeadFormValidation = () => {
      setupValidation('#firstName', 'name');
      setupValidation('#lastName', 'name');
      setupValidation('#email', 'email');
      setupValidation('#phone', 'phone');
    };

    // Smart ZIP-to-utility lookup
    const lookupUtility = async (zip) => {
      if (!zip || zip.length !== 5) return null;
      try {
        const response = await fetch(`/api/zip-utility-lookup?zip=${zip}`);
        const data = await response.json();
        return data;
      } catch (error) {
        console.warn('ZIP lookup failed:', error);
        return null;
      }
    };

    // Auto-populate utility when ZIP is entered
    const zipInput = $('#zip');
    const utilitySelect = $('#utility');
    
    let zipTimeout;
    zipInput.addEventListener('input', (e) => {
      clearTimeout(zipTimeout);
      const zip = e.target.value.trim();
      
      if (zip.length === 5) {
        zipTimeout = setTimeout(async () => {
          const result = await lookupUtility(zip);
          if (result && result.utility) {
            utilitySelect.value = result.utility;
            utilitySelect.style.borderColor = '#10b981'; // Green border for auto-populated
            
            // Show helpful message
            let message = `✅ Found ${result.utilityName}`;
            if (result.powerPairEligible) {
              message += ' - Duke PowerPair eligible!';
            }
            
            const existingMsg = $('.zip-lookup-message');
            if (existingMsg) existingMsg.remove();
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'zip-lookup-message';
            msgDiv.style.cssText = 'color:#10b981;font-size:.8rem;margin-top:.25rem;font-weight:600';
            msgDiv.textContent = message;
            zipInput.parentNode.appendChild(msgDiv);
            
            setTimeout(() => msgDiv.remove(), 3000);
          }
        }, 500); // Debounce by 500ms
      }
    });

    // Hero start
    startBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const zip = $('#zip').value.trim();
      const utility = $('#utility').value;
      if(!zip || !utility){ return }
      // Prefill hidden fields
      $('#zip_hidden').value = zip;
      $('#utility_hidden').value = utility;
      aeEvt('quiz_started', { zip, utility, lead_id: leadId });
      heroForm.closest('.card').scrollIntoView({behavior:'smooth',block:'center'});
      quiz.style.display='block';
      hideQuizSkeleton(); // Hide skeleton when quiz starts
      setupLeadFormValidation(); // Setup validation for lead form
      goto(1);
    });

    // Bill slider with accessibility
    const syncBill = () => { 
      const val = billSlider.value;
      billVal.textContent = `$${val}`;
      $('#bill_hidden').value = val;
      $('#bill-value').textContent = `Current value: $${val} per month`;
    }
    billSlider.addEventListener('input', syncBill); 
    billSlider.addEventListener('change', syncBill); // For keyboard users
    syncBill();
    $('#next1').addEventListener('click', ()=>{ aeEvt('quiz_step_1_complete', { bill: billSlider.value, lead_id: leadId }); goto(2) });

    // Lead capture
    $('#back2').addEventListener('click', ()=> goto(1));
    leadForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      
      // Rate limiting check
      if (!formSecurity.rateLimiter.isAllowed('lead-capture')) {
        alert('Please wait before submitting again.');
        return;
      }
      
      const firstName = formSecurity.sanitizeInput($('#firstName').value.trim());
      const lastName = formSecurity.sanitizeInput($('#lastName').value.trim());
      const email = formSecurity.sanitizeInput($('#email').value.trim());
      const phone = formSecurity.sanitizeInput($('#phone').value.trim());
      const zip = $('#zip_hidden').value.trim();
      const utility = $('#utility_hidden').value.trim();
      const billAmount = +($('#bill_hidden').value||billSlider.value);
      const optIn = $('#optin').checked ? 'yes' : 'no';

      // Persist
      saveState({ leadId, firstName, lastName, email, phone, zip, utility, billAmount, leadCaptured:true });

      // Netlify form submit
      const fd = new FormData(leadForm);
      fd.set('lead_id', leadId);
      fd.set('opt_in', optIn);
      try { await fetch('/', { method:'POST', body: fd }); } catch(_){ }

      // Track Reddit Lead and GA4 generate_lead for lead capture
      const utm = getUtmState();
      if (!sessionStorage.getItem('lead_sent_'+leadId)) {
        fireReddit('Lead', { lead_id: leadId, ...utm });
        fireGA4Lead(leadId, utm);
        sessionStorage.setItem('lead_sent_'+leadId, '1');
        // Push to GTM for unified triggers
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({ event:'lead', lead_id: leadId, ...utm });
      }
      
      // Track + show outcome
      aeEvt('lead_captured', { value:500, currency:'USD', lead_id: leadId });
      
      // Enhanced GA4 tracking for lead generation
      trackGA4FormEvent('lead-form', {
        form_id: 'lead-form',
        lead_id: leadId,
        bill_amount: billAmount,
        zip_code: zip,
        utility_provider: utility,
        opt_in: optIn,
        value: 500
      });
      $('#out_bill').textContent = `$${billAmount}`;
      renderOutcome(billAmount);
      quiz.style.display='none'; outcome.style.display='block'; setProgress(3);

      // Optional: exit-intent preload values
      $('#exit_email').value = email; $('#exit_zip').value = zip; $('#exit_utility').value = utility;

      // Trigger SMS welcome sequence if opted in
      if(optIn==='yes'){
        try { 
          const utm = getUtmState();
          await fetch('/.netlify/functions/sms-triggers', { 
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify({ 
              event: 'lead_opted_in', 
              lead_id: leadId, 
              phone: phone, 
              utm: utm,
              firstName: firstName 
            }) 
          }); 
        } catch(_){ 
          console.warn('SMS trigger failed:', _);
        }
      }
      
      // Trigger email automation sequence
      try { 
        await fetch('/.netlify/functions/email-automation', { 
          method:'POST', 
          headers:{'Content-Type':'application/json'}, 
          body: JSON.stringify({ leadId, email, billAmount, zip, utility }) 
        }); 
      } catch(_){ }
    });

    function renderOutcome(bill){
      const min = Math.round(bill*0.5*12/10)*10; // rough calc
      const max = Math.round(bill*1.0*12/10)*10;
      $('#out_savings').textContent = `$${min.toLocaleString()}–$${max.toLocaleString()}/yr`;
    }

    // Calendly with Purchase tracking
    window.openCalendlyPrefilled = function(firstName, email){
      try {
        Calendly.initPopupWidget({
          url: 'https://calendly.com/davide-admiralenergy/batterysolar-intro?hide_event_type_details=1&hide_gdpr_banner=1' +
               (firstName?`&name=${encodeURIComponent(firstName)}`:'') +
               (email?`&email=${encodeURIComponent(email)}`:'')}); 
        // Track Reddit InitiateCheckout for Calendly opening
        const utm = getUtmState();
        fireReddit('InitiateCheckout', utm);
        
        aeEvt('calendly_opened', { value:750, currency:'USD', lead_id: leadId });
        
        // Listen for Calendly completion events
        window.addEventListener('message', function(e) {
          if (e.data.event && e.data.event.indexOf('calendly') === 0) {
            if (e.data.event === 'calendly.event_scheduled') {
              // Track Reddit Purchase for Calendly booking
              const utm = getUtmState();
              fireReddit('Purchase', { value: 0, currency: 'USD', ...utm });
              
              aeEvt('calendly_booking_completed', { 
                value: 1000, 
                currency: 'USD', 
                lead_id: leadId,
                event_type: e.data.event_type || 'consultation'
              });
              
              // Trigger SMS appointment confirmation if user has opted in
              const state = loadState();
              if (state?.leadCaptured) {
                try {
                  fetch('/.netlify/functions/sms-triggers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                      event: 'appt_booked',
                      lead_id: leadId,
                      phone: state.phone,
                      utm: utm,
                      datetime: 'your scheduled appointment time',
                      firstName: state.firstName
                    })
                  });
                } catch(_) {
                  console.warn('SMS appointment confirmation failed:', _);
                }
              }
            }
          }
        });
      } catch(_){
        console.warn('Calendly initialization failed:', _);
      }
    }
    
    // Enhanced GA4 form tracking for lead generation
    window.trackGA4FormEvent = function(formName, eventData = {}) {
      // Enhanced form tracking specifically for GA4 GTM integration
      const leadId = eventData.lead_id || window.leadId || '';
      
      gtag('event', 'generate_lead', {
        event_category: 'lead_generation',
        event_label: formName,
        form_name: formName,
        lead_id: leadId,
        value: eventData.value || 500,
        currency: 'USD',
        custom_parameter_1: leadId,
        custom_parameter_2: eventData.bill_amount || '',
        custom_parameter_3: eventData.zip_code || '',
        custom_parameter_4: eventData.utility_provider || ''
      });
      
      // Also trigger the form submit event for GTM
      if (typeof dataLayer !== 'undefined') {
        dataLayer.push({
          event: 'form_submit',
          form_name: formName,
          form_id: eventData.form_id || formName.replace(/[^a-z0-9]/gi, '-'),
          lead_id: leadId,
          ...eventData
        });
      }
    };
    // Add Calendly InitiateCheckout tracking for any Calendly buttons
    document.addEventListener('click', (e) => {
      const calendlyButton = e.target.closest('[data-calendly-open], #bookCall');
      if (calendlyButton) {
        const utm = getUtmState();
        fireReddit('InitiateCheckout', utm);
      }
    });
    
    $('#bookCall').addEventListener('click', ()=>{
      const s = loadState();
      openCalendlyPrefilled(s?.firstName||'', s?.email||'');
    });

    // Video mute toggle (Hero video) with enhanced tracking
    (function(){
      const v = document.getElementById('admiralExplainer');
      const b = document.getElementById('explainerMute');
      if (!v || !b) return;
      const sync = ()=>{ b.textContent = v.muted ? '🔇 Unmute' : '🔊 Mute'; };
      b.addEventListener('click', async ()=>{ 
        v.muted = !v.muted; 
        if(!v.paused){ try{ await v.play(); }catch(e){} } 
        sync(); 
        // Track video interaction
        aeEvt('video_mute_toggle', { 
          video_id: 'admiralExplainer', 
          section: 'hero_video', 
          muted: v.muted,
          video_time: Math.round(v.currentTime)
        });
      });
      v.addEventListener('canplay', async()=>{ try{ await v.play(); }catch(e){} });
      v.addEventListener('play', () => {
        aeEvt('video_play', { 
          video_id: 'admiralExplainer', 
          section: 'hero_video',
          video_time: Math.round(v.currentTime)
        });
      });
      v.addEventListener('pause', () => {
        aeEvt('video_interaction', { 
          video_id: 'admiralExplainer', 
          section: 'hero_video', 
          action: 'pause',
          video_time: Math.round(v.currentTime)
        });
      });
      sync();
    })();

    // Video mute toggle (Outcome video) with enhanced tracking
    (function(){
      const v = document.getElementById('outcomeExplainer');
      const b = document.getElementById('outcomeMute');
      if (!v || !b) return;
      const sync = ()=>{ b.textContent = v.muted ? '🔇 Unmute' : '🔊 Mute'; };
      b.addEventListener('click', async ()=>{ 
        v.muted = !v.muted; 
        if(!v.paused){ try{ await v.play(); }catch(e){} } 
        sync(); 
        // Track video interaction
        aeEvt('video_mute_toggle', { 
          video_id: 'outcomeExplainer', 
          section: 'outcome_video', 
          muted: v.muted,
          video_time: Math.round(v.currentTime)
        });
      });
      v.addEventListener('canplay', async()=>{ try{ await v.play(); }catch(e){} });
      v.addEventListener('play', () => {
        aeEvt('video_play', { 
          video_id: 'outcomeExplainer', 
          section: 'outcome_video',
          video_time: Math.round(v.currentTime)
        });
      });
      v.addEventListener('pause', () => {
        aeEvt('video_interaction', { 
          video_id: 'outcomeExplainer', 
          section: 'outcome_video', 
          action: 'pause',
          video_time: Math.round(v.currentTime)
        });
      });
      sync();
    })();

    // Bill Upload Modal logic
    (function(){
      const modal = $('#billModal');
      const openBtn = $('#openBillUpload');
      const closeBtn = $('#bu_close');
      const form = $('#bill-upload');
      const drop = $('#bu_drop');
      const input = $('#dukeBillInput');
      const previewWrap = $('#bu_preview');
      const preview = $('#bu_preview_content');
      const submitBtn = $('#bu_submit');
      const attachBtn = $('#bu_attach_btn');
      const skipBtn = $('#bu_skip');
      let picking = false;

      function open(){ modal.style.display='block'; modal.setAttribute('aria-hidden','false'); syncHidden(); }
      function close(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
      openBtn.addEventListener('click', open); closeBtn.addEventListener('click', close);

      function syncHidden(){
        const s = loadState() || {};
        $('#bu_lead_id').value = leadId;
        $('#bu_email').value = s.email||'';
        $('#bu_first_name').value = s.firstName||'';
        $('#bu_phone').value = s.phone||'';
        $('#bu_opt_in').value = (getCookie('ae_lead_captured')==='1' || s.leadCaptured) ? 'yes' : 'no';
        if(!$('#serviceAddress').value && s.zip){ $('#serviceAddress').value = s.zip; }
      }

      function updateSubmit(){ submitBtn.disabled = !(input?.files?.length>0); }
      function renderPreview(file){
        previewWrap.hidden=false;
        if(file.type.startsWith('image/')){
          const r=new FileReader(); r.onload=ev=> preview.innerHTML = `<img alt="Bill preview" src="${ev.target.result}" style="max-width:100%;max-height:240px;border-radius:8px">`; r.readAsDataURL(file);
        } else { preview.innerHTML = `<div><strong>${file.name}</strong> — ${(file.size/1024).toFixed(1)} KB</div>`; }
      }
      function validate(file){
        const ok = /^(application\/pdf|image\/(jpeg|jpg|png|heic))$/i.test(file.type) || /\.pdf$|\.jpe?g$|\.png$|\.heic$/i.test(file.name);
        if(!ok){ alert('Please upload PDF, JPG, PNG, or HEIC.'); return false; }
        if(file.size > 10*1024*1024){ alert('Max 10 MB.'); return false; }
        return true;
      }

      function openPickerOnce(){ if(picking) return; picking=true; try{ input.value=''; }catch(_){} updateSubmit(); input.click(); }
      drop.addEventListener('click', (e)=>{ e.preventDefault(); openPickerOnce(); });
      drop.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openPickerOnce(); } });
      drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
      ['dragleave','drop'].forEach(evt=> drop.addEventListener(evt, e=>{ e.preventDefault(); drop.classList.remove('dragover'); }));
      drop.addEventListener('drop', e=>{ const f=e.dataTransfer?.files?.[0]; if(f && validate(f)){ input.files=e.dataTransfer.files; renderPreview(f); updateSubmit(); } });
      input.addEventListener('change', ()=>{ picking=false; const f=input.files?.[0]; if(f && validate(f)) renderPreview(f); updateSubmit(); });
      attachBtn.addEventListener('click', ()=>{ picking=false; try{ input.value=''; }catch(_){} updateSubmit(); input.click(); });

      form.addEventListener('submit', async (e)=>{
        const file = input?.files?.[0];
        if(!file){ e.preventDefault(); try{ showToast('Attach your bill to continue (PDF/JPG/PNG/HEIC, up to 10 MB).'); }catch(_){} openPickerOnce(); return; }
        e.preventDefault(); submitBtn.disabled=true; syncHidden();
        aeEvt('file_upload', { type:'duke_bill', lead_id: leadId });
        const fd=new FormData(form);
        try{ await fetch('/', { method:'POST', body:fd }); }catch(_){}
        // Track Reddit Lead and GA4 generate_lead for bill upload
        const utm = getUtmState();
        const lead_id = window.leadId || window.formId || (Date.now()+'-'+Math.random().toString(16).slice(2));
        if (!sessionStorage.getItem('lead_sent_'+lead_id)) {
          fireReddit('Lead', { lead_id, ...utm });
          fireGA4Lead(lead_id, utm);
          sessionStorage.setItem('lead_sent_'+lead_id, '1');
          // Push to GTM for unified triggers
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({ event:'lead', lead_id, ...utm });
        }
        aeEvt('bill_uploaded', { value:1000, currency:'USD', lead_id: leadId });
        showToast("Bill received — we'll build your quote and follow up.");
        close();
        const s = loadState();
        openCalendlyPrefilled(s?.firstName||'', s?.email||'');
        submitBtn.disabled=false;
      });

      skipBtn.addEventListener('click', ()=>{ close(); const s = loadState(); openCalendlyPrefilled(s?.firstName||'', s?.email||''); });
    })();

    // Exit intent (desktop only)
    (function(){
      let shown=false; let armed = true; // fire once per session
      function onLeave(e){
        if(shown||!armed) return; if(e.clientY>0) return; shown=true; aeEvt('exit_intent_shown');
        // Submit hidden form with whatever we captured
        const s = loadState()||{}; $('#exit_email').value = s.email||''; $('#exit_zip').value = s.zip||$('#zip').value||''; $('#exit_utility').value = s.utility||$('#utility').value||'';
        const fd = new FormData($('#exit-form')); fetch('/', { method:'POST', body:fd }).then(()=> aeEvt('exit_intent_converted', { value:250, lead_id: leadId }));
      }
      window.addEventListener('mouseout', onLeave);
    })();

    // Lazy loading for videos
    const lazyLoadVideo = (video) => {
      const skeleton = video.parentElement.querySelector('.video-skeleton');
      if (skeleton) skeleton.style.display = 'none';
      
      const src = video.dataset.src;
      if (src) {
        video.src = src;
        video.removeAttribute('data-src');
        video.addEventListener('loadedmetadata', () => {
          video.classList.add('loaded');
        });
        video.load();
      }
    };

    // Intersection Observer for lazy loading
    const videoObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          lazyLoadVideo(entry.target);
          videoObserver.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1 });

    // Observe all lazy videos
    document.querySelectorAll('.lazy-video').forEach(video => {
      videoObserver.observe(video);
    });

    // Quiz skeleton removal
    const hideQuizSkeleton = () => {
      const skeleton = $('#quizSkeleton');
      if (skeleton) skeleton.style.display = 'none';
    };

    // Touch controls for videos with tracking
    (function(){
      const setupTouchControls = (videoId, playBtnId, touchMuteBtnId) => {
        const video = document.getElementById(videoId);
        const playBtn = document.getElementById(playBtnId);
        const touchMuteBtn = document.getElementById(touchMuteBtnId);
        if(!video || !playBtn || !touchMuteBtn) return;
        
        const updatePlayBtn = () => { playBtn.textContent = video.paused ? '▶️ Play' : '⏸️ Pause'; };
        const updateMuteBtn = () => { touchMuteBtn.textContent = video.muted ? '🔇 Unmute' : '🔊 Mute'; };
        const section = videoId.includes('admiral') ? 'hero_video' : 'outcome_video';
        
        playBtn.addEventListener('click', async () => {
          if(video.paused) {
            try { await video.play(); } catch(e) {}
            aeEvt('video_play', { 
              video_id: videoId, 
              section: section,
              source: 'touch_controls',
              video_time: Math.round(video.currentTime)
            });
          } else {
            video.pause();
            aeEvt('video_interaction', { 
              video_id: videoId, 
              section: section, 
              action: 'pause',
              source: 'touch_controls',
              video_time: Math.round(video.currentTime)
            });
          }
          updatePlayBtn();
        });
        
        touchMuteBtn.addEventListener('click', async () => {
          video.muted = !video.muted;
          if(!video.paused) {
            try { await video.play(); } catch(e) {}
          }
          aeEvt('video_mute_toggle', { 
            video_id: videoId, 
            section: section, 
            muted: video.muted,
            source: 'touch_controls',
            video_time: Math.round(video.currentTime)
          });
          updateMuteBtn();
        });
        
        video.addEventListener('canplay', () => { updatePlayBtn(); updateMuteBtn(); });
      };
      
      setupTouchControls('admiralExplainer', 'playPauseBtn', 'touchMuteBtn');
      setupTouchControls('outcomeExplainer', 'outPlayPauseBtn', 'outTouchMuteBtn');
    })();

    // Live chat toggle
    $('#liveChat').addEventListener('click', ()=>{
      aeEvt('live_chat_opened', { value:300, currency:'USD', lead_id: leadId });
      // Simulate live chat widget - in production, integrate with Intercom, Zendesk, etc.
      const chatWidget = document.createElement('div');
      chatWidget.innerHTML = `
        <div style="position:fixed;bottom:20px;right:20px;background:white;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:1rem;max-width:300px;z-index:1000;border:1px solid #e5e7eb">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
            <strong style="color:var(--primary-navy)">Admiral Energy Support</strong>
            <button onclick="this.closest('[data-chat-widget]').remove()" style="border:none;background:none;font-size:1.2rem;cursor:pointer;color:#666;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">&times;</button>
          </div>
          <p style="margin:.5rem 0;font-size:.9rem;color:var(--text-gray)">Hi! I'm here to help with your solar questions. What would you like to know?</p>
          <div style="display:flex;gap:.5rem;margin-top:.75rem">
            <input id="chatInput" placeholder="Ask about solar..." style="flex:1;padding:.5rem;border:1px solid #ddd;border-radius:6px;font-size:.85rem" />
            <button id="chatSend" style="padding:.5rem .75rem;background:#0084FF;color:white;border:none;border-radius:6px;cursor:pointer;transition:background .2s" onmouseover="this.style.background='#0056CC'" onmouseout="this.style.background='#0084FF'">Send</button>
          </div>
          <div id="chatResponse" style="margin-top:.75rem;padding:.5rem;background:#f8f9fa;border-radius:6px;font-size:.85rem;display:none"></div>
        </div>
      `;
      chatWidget.setAttribute('data-chat-widget', 'true');
      document.body.appendChild(chatWidget);
      
      // Add functionality to the chat
      const chatInput = chatWidget.querySelector('#chatInput');
      const chatSend = chatWidget.querySelector('#chatSend');
      const chatResponse = chatWidget.querySelector('#chatResponse');
      
      const sendMessage = () => {
        const message = chatInput.value.trim();
        if (!message) return;
        
        // Show typing indicator
        chatResponse.style.display = 'block';
        chatResponse.innerHTML = '<em style="color:#666">Agent is typing...</em>';
        
        // Simulate response after delay
        setTimeout(() => {
          const responses = [
            "Thanks for your question! A solar specialist will contact you within 30 minutes to provide detailed information.",
            "Great question! Based on your earlier quiz, you're eligible for up to $9,000 in Duke PowerPair rebates. Let me schedule a call to discuss specifics.",
            "I'd be happy to help! For personalized solar calculations, our team will need to review your specific roof and energy usage. Would you like to schedule a consultation?",
            "Thanks for reaching out! Our Duke PowerPair specialists are available now. Would you prefer a callback or to schedule your free consultation?"
          ];
          const response = responses[Math.floor(Math.random() * responses.length)];
          chatResponse.innerHTML = response + '<br><br><button onclick="window.openCalendlyPrefilled()" style="background:var(--accent-gold);color:white;border:none;padding:.4rem .8rem;border-radius:6px;cursor:pointer;font-size:.8rem">Schedule Consultation</button>';
        }, 1500);
        
        chatInput.value = '';
        aeEvt('chat_message_sent', { message, lead_id: leadId });
      };
      
      chatSend.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // Focus input when chat opens
      setTimeout(() => chatInput.focus(), 100);
    });

    // Business hours check for instant callback (9am-5pm ET, Mon-Fri)
    function isBusinessHours() {
      const now = new Date();
      const et = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/New_York',
        hour: 'numeric',
        minute: 'numeric',
        hour12: false,
        weekday: 'short'
      });
      
      const etTime = et.formatToParts(now);
      const dayOfWeek = etTime.find(part => part.type === 'weekday').value;
      const hour = parseInt(etTime.find(part => part.type === 'hour').value);
      
      // Check if it's Monday-Friday
      const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
      const isWeekday = weekdays.includes(dayOfWeek);
      
      // Check if it's between 9am-5pm ET
      const isBusinessTime = hour >= 9 && hour < 17;
      
      return isWeekday && isBusinessTime;
    }
    
    // Instant callback with business hours validation
    $('#instantCallback').addEventListener('click', ()=>{
      const s = loadState();
      if(!s?.phone){
        alert('Please complete the savings quiz first so we have your phone number!');
        return;
      }
      
      if(!isBusinessHours()){
        alert('Instant callbacks are available Monday-Friday, 9:00 AM - 5:00 PM Eastern Time. Please schedule a consultation or try again during business hours.');
        // Open Calendly instead
        openCalendlyPrefilled(s?.firstName||'', s?.email||'');
        return;
      }
      
      aeEvt('instant_callback_requested', { value:500, currency:'USD', lead_id: leadId });
      alert(`Thanks! We'll call you at ${s.phone} within the next 5 minutes.`);
      
      // Actual callback system request
      fetch('/.netlify/functions/request-callback', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
          leadId, 
          phone: s.phone, 
          firstName: s.firstName,
          email: s.email,
          billAmount: s.billAmount,
          zip: s.zip,
          utility: s.utility
        })
      }).then(response => response.json())
      .then(data => {
        if(!data.success) {
          throw new Error(data.message || 'Callback request failed');
        }
        aeEvt('instant_callback_scheduled', { 
          value: 500, 
          currency: 'USD', 
          lead_id: leadId,
          callback_window: data.data?.callbackWindow || '5-10 minutes'
        });
      })
      .catch(error => {
        console.error('Callback request error:', error);
        alert('Sorry, there was an issue scheduling your callback. Please try booking a consultation instead.');
        openCalendlyPrefilled(s?.firstName||'', s?.email||'');
      });
    });

    // Cookie consent and privacy compliance
    const cookieConsent = {
      init() {
        if (!this.hasConsented()) {
          setTimeout(() => this.showConsent(), 2000); // Show after 2 seconds
        }
        this.setupEventListeners();
      },
      
      hasConsented() {
        return localStorage.getItem('ae_cookie_consent') !== null;
      },
      
      showConsent() {
        const modal = $('#cookieConsent');
        modal.style.display = 'block';
        modal.setAttribute('aria-hidden', 'false');
      },
      
      hideConsent() {
        const modal = $('#cookieConsent');
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
      },
      
      acceptAll() {
        localStorage.setItem('ae_cookie_consent', JSON.stringify({
          essential: true,
          analytics: true,
          marketing: true,
          timestamp: Date.now()
        }));
        this.hideConsent();
        gtag('consent', 'update', {
          'analytics_storage': 'granted',
          'ad_storage': 'granted'
        });
      },
      
      declineNonEssential() {
        localStorage.setItem('ae_cookie_consent', JSON.stringify({
          essential: true,
          analytics: false,
          marketing: false,
          timestamp: Date.now()
        }));
        this.hideConsent();
        gtag('consent', 'update', {
          'analytics_storage': 'denied',
          'ad_storage': 'denied'
        });
      },
      
      setupEventListeners() {
        $('#acceptCookies')?.addEventListener('click', () => this.acceptAll());
        $('#declineCookies')?.addEventListener('click', () => this.declineNonEssential());
        $('#manageCookies')?.addEventListener('click', () => this.showPreferences());
        
        // Privacy policy link
        document.addEventListener('click', (e) => {
          if (e.target.getAttribute('href') === '#privacy') {
            e.preventDefault();
            $('#privacyModal').style.display = 'block';
          }
        });
      },
      
      showPreferences() {
        // Simplified - in production, show detailed preference modal
        alert('Cookie preferences: Essential cookies are required. Analytics cookies help improve our service. You can change preferences anytime.');
      }
    };
    
    // Form security enhancements
    const formSecurity = {
      // Generate CSRF token
      generateCSRFToken() {
        return 'csrf_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
      },
      
      // Add CSRF protection to forms
      protectForm(formElement) {
        if (!formElement) return;
        
        let csrfInput = formElement.querySelector('input[name="csrf_token"]');
        if (!csrfInput) {
          csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrf_token';
          formElement.appendChild(csrfInput);
        }
        csrfInput.value = this.generateCSRFToken();
      },
      
      // Basic XSS protection for inputs
      sanitizeInput(input) {
        return input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                   .replace(/javascript:/gi, '')
                   .replace(/on\w+\s*=/gi, '');
      },
      
      // Rate limiting for form submissions
      rateLimiter: {
        submissions: {},
        isAllowed(formName) {
          const now = Date.now();
          const lastSubmission = this.submissions[formName];
          
          if (!lastSubmission || (now - lastSubmission) > 10000) { // 10 second cooldown
            this.submissions[formName] = now;
            return true;
          }
          return false;
        }
      }
    };
    
    // Initialize privacy compliance
    cookieConsent.init();
    
    // Apply form security to all forms and setup GA4 tracking
    document.querySelectorAll('form').forEach(form => {
      formSecurity.protectForm(form);
      
      // Setup GA4 tracking for forms with specific classes/IDs
      if (form.classList.contains('hs-form') || form.id === 'lead-form') {
        form.addEventListener('submit', function(e) {
          // Track form submission for GA4
          const formData = new FormData(this);
          const eventData = {
            form_id: this.id || 'unknown-form',
            lead_id: formData.get('lead_id') || window.leadId || '',
            bill_amount: formData.get('bill_amount') || '',
            zip_code: formData.get('zip') || '',
            utility_provider: formData.get('utility') || '',
            first_name: formData.get('first_name') || '',
            email: formData.get('email') || '',
            phone: formData.get('phone') || '',
            opt_in: formData.get('opt_in') || 'no'
          };
          
          // Track the event
          trackGA4FormEvent(this.id || this.name || 'form-submit', eventData);
        });
      }
    });
    $('#year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
