<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <meta name="supported-color-schemes" content="light" />
  <meta name="theme-color" content="#f7f5f2" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <title>Admiral Energy â€” Lower Bills. Quiet Backup. Solar That Fits.</title>

  <!-- Favicon set (generated at build) -->
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16.png?v=2" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32.png?v=2" />
  <link rel="icon" type="image/png" sizes="48x48" href="/assets/favicon-48.png?v=2" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png?v=2" />
  <link rel="icon" href="/assets/favicon.ico?v=2" sizes="any" />
  <link rel="shortcut icon" href="/assets/favicon.ico?v=2" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Admiral Energy â€” Lower Bills. Quiet Backup. Solar That Fits." />
  <meta property="og:description" content="60 seconds to check fit for solar + battery. No pressure, no spam." />
  <meta property="og:image" content="/assets/share-image.png" />
  <meta property="og:url" content="https://admiralenergy.netlify.app" />
  <meta property="og:site_name" content="Admiral Energy" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Admiral Energy â€” Lower Bills. Quiet Backup. Solar That Fits." />
  <meta name="twitter:description" content="60 seconds to check fit for solar + battery. No pressure, no spam." />
  <meta name="twitter:image" content="/assets/share-image.png" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Calendly -->
  <link href="https://assets.calendly.com/assets/external/widget.css" rel="stylesheet" />
  <script src="https://assets.calendly.com/assets/external/widget.js" async></script>

  <!-- GTM -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PDPNZ37H');
  </script>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RX78MRB03L"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-RX78MRB03L');
  </script>

  <style>
    :root{
      --primary-navy:#0c2f4a; --accent-gold:#c9a648; --dark-gold:#9b7b2d; --bone-white:#f7f5f2; --text-gray:#6b7280;
    }
    *{box-sizing:border-box} html,body{margin:0;padding:0;font-family:"Rubik",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:var(--bone-white);color:#1f2937}
    a{color:var(--primary-navy)}
    .container{max-width:1100px;margin:0 auto;padding:1.25rem}
    header{background:linear-gradient(135deg,#fff,rgba(201,166,72,.08));border-bottom:1px solid #eee}
    .hero{display:grid;gap:1.25rem;grid-template-columns:1.2fr .8fr;align-items:center;padding:2rem 0}
    .badgeRow{display:flex;gap:.75rem;flex-wrap:wrap;margin:.5rem 0}
    .badgeRow span{background:#fff;border:1px solid #e5e7eb;padding:.35rem .6rem;border-radius:999px;font-size:.8rem}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 30px rgba(12,47,74,.06)}
    .cardPad{padding:1rem}

    .cta{display:flex;gap:.5rem}
    .cta input,.cta select{flex:1;padding:.9rem;border-radius:12px;border:1px solid #d7d3cb;background:#fff;min-width:0}
    .btn{padding:.95rem 1rem;border-radius:12px;border:none;font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--accent-gold),var(--dark-gold));color:#fff}
    .btn-secondary{background:transparent;color:var(--primary-navy);border:2px solid var(--primary-navy)}

    /* Progress */
    .progress{height:8px;background:#ececec;border-radius:999px;overflow:hidden;margin:.5rem 0}
    .progress-fill{height:100%;width:0;background:linear-gradient(90deg,var(--accent-gold),var(--dark-gold));transition:width .35s ease}

    /* Quiz */
    .quiz{margin-top:1rem}
    .quiz-step{display:none}
    .quiz-step.active{display:block;animation:fade .35s ease}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    .options-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem}
    .option-card{padding:1rem;border:2px solid #e5e7eb;border-radius:10px;text-align:center;cursor:pointer;background:#fff;transition:.2s}
    .option-card:hover{border-color:var(--accent-gold);transform:translateY(-2px)}
    .option-card.selected{border-color:var(--accent-gold);background:linear-gradient(135deg,rgba(201,166,72,.08),rgba(201,166,72,.03))}

    .bill-display{text-align:center;font-size:1.8rem;font-weight:800;color:var(--primary-navy)}

    .outcome-card{background:linear-gradient(135deg,#fff,rgba(201,166,72,.05));border-radius:20px;padding:2rem;margin-top:1rem}
    .savings-highlight{background:linear-gradient(135deg,var(--accent-gold),var(--dark-gold));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-size:2.4rem;font-weight:900}

    .next-steps{display:grid;grid-template-columns:1.1fr .9fr;gap:1.25rem;align-items:start;margin-top:1rem}
    .actions{display:flex;gap:.75rem;flex-wrap:wrap}
    .actions .btn{min-width:220px}

    /* Upload Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:50;padding:1rem;overflow:auto}
    .modal .box{max-width:620px;margin:2rem auto;background:#fff;border-radius:20px;padding:1.5rem}
    .upload-zone{border:2px dashed var(--accent-gold);border-radius:12px;padding:2rem;text-align:center;background:rgba(201,166,72,.06);cursor:pointer}
    .upload-zone:hover{background:rgba(201,166,72,.1)}
    .upload-zone.dragover{background:rgba(201,166,72,.15);transform:scale(1.01)}
    .file-preview{margin-top:1rem;padding:1rem;background:var(--bone-white);border-radius:10px}

    /* Trust */
    .trust{padding:3rem 0}
    .badges{display:flex;justify-content:center;gap:2rem;flex-wrap:wrap;margin-bottom:2rem}
    .badge{display:flex;flex-direction:column;align-items:center;gap:.35rem}
    .badge .ico{width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,rgba(201,166,72,.1),rgba(201,166,72,.05))}

    footer{padding:2rem 0;color:#6b7280;text-align:center}

    @media (max-width:880px){
      .hero{grid-template-columns:1fr}
      .actions .btn{flex:1 1 100%;min-width:0}
      video{width:100%;height:auto}
    }
  </style>
</head>
<body>
  <!-- GTM (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PDPNZ37H" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <header>
    <div class="container hero">
      <div>
        <h1 style="margin:0 0 .35rem;color:var(--primary-navy);font-size:2.2rem;line-height:1.15">Lower Bills. Quiet Backup. Solar That Fits.</h1>
        <p style="margin:.25rem 0 1rem;color:var(--text-gray);max-width:56ch">60 seconds to check fit for solar + battery in Charlotte. Veteranâ€‘owned. No pressure, no spam.</p>
        <div class="badgeRow">
          <span>âœ… Licensed & Insured</span>
          <span>âš¡ 25â€‘Year Warranty</span>
          <span>ğŸ“ Local Team</span>
          <span>ğŸ–ï¸ Veteranâ€‘Owned</span>
        </div>

        <!-- Lead / Hero minimal form (ZIP + Utility) -->
        <div class="card cardPad">
          <form id="heroForm" class="cta" onsubmit="return false">
            <input required id="zip" name="zip" inputmode="numeric" pattern="[0-9]{5}" placeholder="ZIP code" aria-label="ZIP code" />
            <select required id="utility" name="utility" aria-label="Utility">
              <option value="" disabled selected>Utility</option>
              <option value="duke">Duke Energy</option>
              <option value="other">Other</option>
            </select>
            <button class="btn btn-primary" id="startQuiz">Check savings</button>
          </form>
          <div class="progress" aria-hidden="true"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
          <div id="welcomeBack" style="display:none;color:#065f46;font-weight:700;margin-top:.25rem"></div>
        </div>
      </div>

      <div class="card">
        <video id="admiralExplainer" class="cardPad" style="border-radius:16px" playsinline muted loop preload="metadata"
               src="/assets/admiral-intro.mp4"></video>
        <div class="cardPad" style="display:flex;justify-content:flex-end"><button id="explainerMute" class="btn btn-secondary" type="button">ğŸ”Š Mute</button></div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- QUIZ -->
    <section id="quiz" class="quiz card cardPad" aria-live="polite" style="display:none">
      <!-- Step 1: Bill amount -->
      <div class="quiz-step" data-step="1">
        <h3 style="margin-top:0;color:var(--primary-navy)">Whatâ€™s your average monthly electric bill?</h3>
        <input type="range" min="50" max="500" value="150" step="5" id="billSlider" class="slider" />
        <div class="bill-display"><span id="billVal">$150</span>/mo</div>
        <p class="micro-value">Preview: Many Charlotte homes at this bill level save 30â€“55% with solar + battery.</p>
        <div style="display:flex;gap:.5rem;justify-content:flex-end"><button class="btn btn-primary" id="next1">Next â†’</button></div>
      </div>

      <!-- Step 2: Contact info (LEAD CAPTURE) -->
      <div class="quiz-step" data-step="2">
        <h3 style="margin-top:0;color:var(--primary-navy)">Where should we send your savings report?</h3>
        <form id="leadForm" name="lead-capture" method="POST" data-netlify="true">
          <input type="hidden" name="form-name" value="lead-capture" />
          <input type="hidden" name="lead_id" id="lead_id" />
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
            <input required name="first_name" id="firstName" placeholder="First name" />
            <input required name="last_name" id="lastName" placeholder="Last name" />
            <input required type="email" name="email" id="email" placeholder="Email" />
            <input required name="phone" id="phone" placeholder="Phone" />
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:.75rem">
            <input required name="zip" id="zip_hidden" placeholder="ZIP" />
            <input required name="utility" id="utility_hidden" placeholder="Utility" />
          </div>
          <input type="hidden" name="bill_amount" id="bill_hidden" />
          <label style="display:flex;gap:.5rem;align-items:center;margin:.75rem 0 0">
            <input type="checkbox" id="optin" name="opt_in" value="yes" />
            <span style="font-size:.9rem;color:#374151">Okay to email & text me my savings report and updates. I can reply STOP to opt out.</span>
          </label>
          <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.75rem">
            <button type="button" class="btn btn-secondary" id="back2">â† Back</button>
            <button type="submit" class="btn btn-primary" id="submitLead">See my savings</button>
          </div>
        </form>
      </div>

      <!-- Step 3: Optional refinement -->
      <div class="quiz-step" data-step="3">
        <h3 style="margin-top:0;color:var(--primary-navy)">A few quick details (optional)</h3>
        <div class="options-grid" id="roofType">
          <div class="option-card" data-val="shingle">ğŸ  Shingle Roof</div>
          <div class="option-card" data-val="metal">ğŸ”© Metal Roof</div>
          <div class="option-card" data-val="tile">ğŸ§± Tile Roof</div>
          <div class="option-card" data-val="flat">â¬œ Flat Roof</div>
        </div>
        <p class="micro-value">This helps us right-size your system. You can skip this step.</p>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem">
          <button class="btn btn-secondary" id="skip3">Skip</button>
          <button class="btn btn-primary" id="next3">Continue</button>
        </div>
      </div>
    </section>

    <!-- OUTCOME -->
    <section id="outcome" style="display:none">
      <div class="outcome-card">
        <h2 style="margin:.25rem 0 0;color:var(--primary-navy)">You're a strong fit for solar + battery</h2>
        <p style="margin:.25rem 0;color:var(--text-gray)">Based on your bill of <strong id="out_bill">$150</strong>/mo, typical savings look like:</p>
        <div class="savings-highlight" id="out_savings">$900â€“$1,800/yr</div>
        <div class="next-steps">
          <div class="actions">
            <button class="btn btn-primary" id="bookCall">ğŸ“… Book a 15â€‘min review</button>
            <button class="btn btn-secondary" id="openBillUpload">ğŸ“ Upload Duke bill (faster quote)</button>
          </div>
          <div>
            <video class="admiral-explainer" playsinline muted loop preload="metadata" style="width:100%;border-radius:16px" src="/assets/admiral-intro.mp4"></video>
            <p style="color:var(--text-gray);font-size:.9rem;margin:.35rem 0 0">We use your address (roof & sun) + kWh from your bill to size your system precisely.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- TRUST -->
    <section class="trust">
      <h2 style="text-align:center;color:var(--primary-navy);font-size:2rem">Why Charlotte Homeowners Trust Admiral Energy</h2>
      <div class="badges">
        <div class="badge"><div class="ico">ğŸ–ï¸</div><span style="font-weight:600">Veteranâ€‘Owned</span></div>
        <div class="badge"><div class="ico">ğŸ“</div><span style="font-weight:600">Local Team</span></div>
        <div class="badge"><div class="ico">âœ…</div><span style="font-weight:600">Licensed & Insured</span></div>
        <div class="badge"><div class="ico">ğŸ› ï¸</div><span style="font-weight:600">25â€‘Year Warranty</span></div>
        <div class="badge"><div class="ico">âš¡</div><span style="font-weight:600">Workmanship Guarantee</span></div>
      </div>
      <div class="card cardPad" style="display:grid;gap:1rem;grid-template-columns:1fr 1fr">
        <blockquote style="margin:0"><p style="margin:0 0 .35rem">â€œOutage last week? We didnâ€™t noticeâ€”battery switched instantly. The Admiral team handled everything from permits to install.â€</p><cite style="color:var(--text-gray)">â€” Sarah M., Myers Park</cite></blockquote>
        <blockquote style="margin:0"><p style="margin:0 0 .35rem">â€œCut my Duke Energy bill by 45% and the battery backup gives us peace of mind during storm season. Professional crew, zero hassle.â€</p><cite style="color:var(--text-gray)">â€” Tony R., Ballantyne</cite></blockquote>
      </div>
    </section>
  </main>

  <!-- Bill Upload Modal (Netlify form) -->
  <div class="modal" id="billModal" aria-hidden="true">
    <div class="box">
      <form id="bill-upload" name="bill-upload" method="POST" data-netlify="true" enctype="multipart/form-data">
        <input type="hidden" name="form-name" value="bill-upload" />
        <input type="hidden" name="lead_id" id="bu_lead_id" />
        <input type="hidden" name="email" id="bu_email" />
        <input type="hidden" name="first_name" id="bu_first_name" />
        <input type="hidden" name="phone" id="bu_phone" />
        <input type="hidden" name="opt_in" id="bu_opt_in" value="no" />

        <h3 style="margin:0 0 .25rem">Upload your Duke bill (front page)</h3>
        <p style="margin:.25rem 0;color:var(--text-gray)">We use your <strong>address</strong> (roof & sun) and <strong>kWh</strong> (system size). You may hide your account #. <a href="/assets/duke-bill-sample.png" target="_blank" rel="noopener">See sample</a>.</p>

        <div id="bu_drop" class="upload-zone" role="button" tabindex="0">ğŸ“ Drag & drop or click â€” PDF/JPG/PNG/HEIC (max 10 MB)</div>
        <button type="button" id="bu_attach_btn" class="btn btn-secondary" style="width:100%;margin-top:.5rem">ğŸ“ Attach bill</button>
        <input type="file" id="dukeBillInput" name="duke_bill" accept=".pdf,.jpg,.jpeg,.png,.heic,image/*,application/pdf" capture="environment" style="display:none" />

        <div class="file-preview" id="bu_preview" hidden>
          <strong>Selected file</strong>
          <div id="bu_preview_content" style="margin-top:.35rem"></div>
        </div>

        <label for="serviceAddress" style="display:block;margin:.75rem 0 .25rem;font-weight:600">Service address (optional)</label>
        <input id="serviceAddress" name="service_address" placeholder="Street, City, ZIP" style="width:100%;padding:.8rem;border:1px solid #d7d3cb;border-radius:10px" />

        <div style="display:flex;gap:.5rem;justify-content:center;margin-top:1rem">
          <button type="submit" class="btn btn-primary" id="bu_submit" disabled>Submit & Book My Review Call</button>
          <button type="button" class="btn btn-secondary" id="bu_skip">Skip â€” Book without upload</button>
          <button type="button" class="btn" id="bu_close">Close</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Exit Intent (Netlify form) -->
  <form id="exit-form" name="exit-intent-capture" method="POST" data-netlify="true" hidden>
    <input type="hidden" name="form-name" value="exit-intent-capture" />
    <input type="hidden" name="email" id="exit_email" />
    <input type="hidden" name="zip" id="exit_zip" />
    <input type="hidden" name="utility" id="exit_utility" />
  </form>

  <footer>
    <div class="container">Â© <span id="year"></span> Admiral Energy â€” Charlotte, NC â€¢ Licensed & Insured</div>
  </footer>

  <script>
    // Small helpers
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
    const aeEvt = (name, params={}) => { try { gtag('event', name, params); } catch(_){} };
    const showToast = (msg) => { try{ if(window.Toastify){ Toastify({text:msg}).showToast(); } }catch(_) { console.log('[Toast]', msg) } };

    // Debug flag via ?debug=1
    (function(){ const q=new URLSearchParams(location.search); window.AE_DEBUG = window.AE_DEBUG || (q.get('debug')==='1');})();

    // Lead ID + cookie/localStorage persistence (30 days)
    function makeLeadId(){ return 'lead_'+Date.now()+'_'+Math.random().toString(36).slice(2,8); }
    function setCookie(k,v,days){ const d=new Date(Date.now()+days*864e5).toUTCString(); document.cookie=`${k}=${encodeURIComponent(v)}; path=/; expires=${d}`; }
    function getCookie(k){ return document.cookie.split('; ').find(r=>r.startsWith(k+'='))?.split('=')[1] }

    function saveState(data){
      const state = { ...data, timestamp: Date.now() };
      try { localStorage.setItem('ae_state', JSON.stringify(state)); } catch(_){ }
      if(data.leadId){ setCookie('ae_lead_id', data.leadId, 30); setCookie('ae_lead_captured', data.leadCaptured?'1':'0', 30); }
    }
    function loadState(){ try{ const s=localStorage.getItem('ae_state'); return s?JSON.parse(s):null }catch(_){ return null } }

    // UI state
    const heroForm = $('#heroForm');
    const startBtn = $('#startQuiz');
    const quiz = $('#quiz');
    const steps = $$('.quiz-step');
    const progressFill = $('#progressFill');

    const billSlider = $('#billSlider');
    const billVal = $('#billVal');

    const leadForm = $('#leadForm');
    const outcome = $('#outcome');

    let leadId = getCookie('ae_lead_id') || makeLeadId();

    function setProgress(stepIdx, total=3){ const pct = Math.max(5, Math.round((stepIdx/total)*100)); progressFill.style.width = pct+'%'; }
    function goto(step){ steps.forEach(s=>s.classList.remove('active')); const el = steps.find(s=>s.dataset.step==step); if(el){ el.classList.add('active'); setProgress(step-1); } }

    // Welcome-back logic
    (function(){
      const state = loadState();
      if(state?.leadCaptured){
        $('#welcomeBack').style.display='block';
        $('#welcomeBack').textContent = `Welcome back${state.firstName ? ', '+state.firstName : ''}! Your quote is ready.`;
        billVal.textContent = `$${state.billAmount||150}`;
        $('#out_bill').textContent = `$${state.billAmount||150}`;
        renderOutcome(state.billAmount||150);
        heroForm.style.display='none';
        quiz.style.display='none';
        outcome.style.display='block';
        setProgress(3);
      }
    })();

    // Hero start
    startBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const zip = $('#zip').value.trim();
      const utility = $('#utility').value;
      if(!zip || !utility){ return }
      // Prefill hidden fields
      $('#zip_hidden').value = zip;
      $('#utility_hidden').value = utility;
      aeEvt('quiz_started', { zip, utility, lead_id: leadId });
      heroForm.closest('.card').scrollIntoView({behavior:'smooth',block:'center'});
      quiz.style.display='block';
      goto(1);
    });

    // Bill slider
    const syncBill = () => { billVal.textContent = `$${billSlider.value}`; $('#bill_hidden').value = billSlider.value }
    billSlider.addEventListener('input', syncBill); syncBill();
    $('#next1').addEventListener('click', ()=>{ aeEvt('quiz_step_1_complete', { bill: billSlider.value, lead_id: leadId }); goto(2) });

    // Lead capture
    $('#back2').addEventListener('click', ()=> goto(1));
    leadForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const firstName = $('#firstName').value.trim();
      const lastName = $('#lastName').value.trim();
      const email = $('#email').value.trim();
      const phone = $('#phone').value.trim();
      const zip = $('#zip_hidden').value.trim();
      const utility = $('#utility_hidden').value.trim();
      const billAmount = +($('#bill_hidden').value||billSlider.value);
      const optIn = $('#optin').checked ? 'yes' : 'no';

      // Persist
      saveState({ leadId, firstName, lastName, email, phone, zip, utility, billAmount, leadCaptured:true });

      // Netlify form submit
      const fd = new FormData(leadForm);
      fd.set('lead_id', leadId);
      fd.set('opt_in', optIn);
      try { await fetch('/', { method:'POST', body: fd }); } catch(_){ }

      // Track + show outcome
      aeEvt('lead_captured', { value:500, currency:'USD', lead_id: leadId });
      $('#out_bill').textContent = `$${billAmount}`;
      renderOutcome(billAmount);
      quiz.style.display='none'; outcome.style.display='block'; setProgress(3);

      // Optional: exit-intent preload values
      $('#exit_email').value = email; $('#exit_zip').value = zip; $('#exit_utility').value = utility;

      // Optional SMS via Netlify Function (requires env + function deploy)
      if(optIn==='yes'){
        try { await fetch('/.netlify/functions/send-sms', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ leadId, firstName, email, phone }) }); } catch(_){ }
      }
    });

    function renderOutcome(bill){
      const min = Math.round(bill*0.5*12/10)*10; // rough calc
      const max = Math.round(bill*1.0*12/10)*10;
      $('#out_savings').textContent = `$${min.toLocaleString()}â€“$${max.toLocaleString()}/yr`;
    }

    // Calendly
    window.openCalendlyPrefilled = function(firstName, email){
      try {
        Calendly.initPopupWidget({
          url: 'https://calendly.com/admiral-energy/15min?hide_event_type_details=1&hide_gdpr_banner=1' +
               (firstName?`&name=${encodeURIComponent(firstName)}`:'') +
               (email?`&email=${encodeURIComponent(email)}`:'')
        });
        aeEvt('calendly_opened', { value:750, currency:'USD', lead_id: leadId });
      } catch(_){}
    }
    $('#bookCall').addEventListener('click', ()=>{
      const s = loadState();
      openCalendlyPrefilled(s?.firstName||'', s?.email||'');
    });

    // Video mute toggle
    (function(){
      const v = document.getElementById('admiralExplainer');
      const b = document.getElementById('explainerMute');
      if (!v || !b) return;
      const sync = ()=>{ b.textContent = v.muted ? 'ğŸ”‡ Unmute' : 'ğŸ”Š Mute'; };
      b.addEventListener('click', async ()=>{ v.muted = !v.muted; if(!v.paused){ try{ await v.play(); }catch(e){} } sync(); });
      v.addEventListener('canplay', async()=>{ try{ await v.play(); }catch(e){} });
      sync();
    })();

    // Bill Upload Modal logic
    (function(){
      const modal = $('#billModal');
      const openBtn = $('#openBillUpload');
      const closeBtn = $('#bu_close');
      const form = $('#bill-upload');
      const drop = $('#bu_drop');
      const input = $('#dukeBillInput');
      const previewWrap = $('#bu_preview');
      const preview = $('#bu_preview_content');
      const submitBtn = $('#bu_submit');
      const attachBtn = $('#bu_attach_btn');
      const skipBtn = $('#bu_skip');
      let picking = false;

      function open(){ modal.style.display='block'; modal.setAttribute('aria-hidden','false'); syncHidden(); }
      function close(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
      openBtn.addEventListener('click', open); closeBtn.addEventListener('click', close);

      function syncHidden(){
        const s = loadState() || {};
        $('#bu_lead_id').value = leadId;
        $('#bu_email').value = s.email||'';
        $('#bu_first_name').value = s.firstName||'';
        $('#bu_phone').value = s.phone||'';
        $('#bu_opt_in').value = (getCookie('ae_lead_captured')==='1' || s.leadCaptured) ? 'yes' : 'no';
        if(!$('#serviceAddress').value && s.zip){ $('#serviceAddress').value = s.zip; }
      }

      function updateSubmit(){ submitBtn.disabled = !(input?.files?.length>0); }
      function renderPreview(file){
        previewWrap.hidden=false;
        if(file.type.startsWith('image/')){
          const r=new FileReader(); r.onload=ev=> preview.innerHTML = `<img alt="Bill preview" src="${ev.target.result}" style="max-width:100%;max-height:240px;border-radius:8px">`; r.readAsDataURL(file);
        } else { preview.innerHTML = `<div><strong>${file.name}</strong> â€” ${(file.size/1024).toFixed(1)} KB</div>`; }
      }
      function validate(file){
        const ok = /^(application\/pdf|image\/(jpeg|jpg|png|heic))$/i.test(file.type) || /\.pdf$|\.jpe?g$|\.png$|\.heic$/i.test(file.name);
        if(!ok){ alert('Please upload PDF, JPG, PNG, or HEIC.'); return false; }
        if(file.size > 10*1024*1024){ alert('Max 10 MB.'); return false; }
        return true;
      }

      function openPickerOnce(){ if(picking) return; picking=true; try{ input.value=''; }catch(_){} updateSubmit(); input.click(); }
      drop.addEventListener('click', (e)=>{ e.preventDefault(); openPickerOnce(); });
      drop.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openPickerOnce(); } });
      drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
      ['dragleave','drop'].forEach(evt=> drop.addEventListener(evt, e=>{ e.preventDefault(); drop.classList.remove('dragover'); }));
      drop.addEventListener('drop', e=>{ const f=e.dataTransfer?.files?.[0]; if(f && validate(f)){ input.files=e.dataTransfer.files; renderPreview(f); updateSubmit(); } });
      input.addEventListener('change', ()=>{ picking=false; const f=input.files?.[0]; if(f && validate(f)) renderPreview(f); updateSubmit(); });
      attachBtn.addEventListener('click', ()=>{ picking=false; try{ input.value=''; }catch(_){} updateSubmit(); input.click(); });

      form.addEventListener('submit', async (e)=>{
        const file = input?.files?.[0];
        if(!file){ e.preventDefault(); try{ showToast('Attach your bill to continue (PDF/JPG/PNG/HEIC, up to 10 MB).'); }catch(_){} openPickerOnce(); return; }
        e.preventDefault(); submitBtn.disabled=true; syncHidden();
        aeEvt('file_upload', { type:'duke_bill', lead_id: leadId });
        const fd=new FormData(form);
        try{ await fetch('/', { method:'POST', body:fd }); }catch(_){}
        aeEvt('bill_uploaded', { value:1000, currency:'USD', lead_id: leadId });
        showToast("Bill received â€” we'll build your quote and follow up.");
        close();
        const s = loadState();
        openCalendlyPrefilled(s?.firstName||'', s?.email||'');
        submitBtn.disabled=false;
      });

      skipBtn.addEventListener('click', ()=>{ close(); const s = loadState(); openCalendlyPrefilled(s?.firstName||'', s?.email||''); });
    })();

    // Exit intent (desktop only)
    (function(){
      let shown=false; let armed = true; // fire once per session
      function onLeave(e){
        if(shown||!armed) return; if(e.clientY>0) return; shown=true; aeEvt('exit_intent_shown');
        // Submit hidden form with whatever we captured
        const s = loadState()||{}; $('#exit_email').value = s.email||''; $('#exit_zip').value = s.zip||$('#zip').value||''; $('#exit_utility').value = s.utility||$('#utility').value||'';
        const fd = new FormData($('#exit-form')); fetch('/', { method:'POST', body:fd }).then(()=> aeEvt('exit_intent_converted', { value:250, lead_id: leadId }));
      }
      window.addEventListener('mouseout', onLeave);
    })();

    // Footer year
    $('#year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
